# 期货回测框架
随意指定策略参数，并获得策略在回测区间内的表现

提供
- 回测过程中的**完整交易日志**
- 回测结果：策略绩效表现，包括**年化收益率、夏普比率、最大回撤、胜率和盈亏比**

适合 
- 构建并测试量价/基本面因子表现的交易者  
- 监控量价/基本面因子表现的交易者  
- 想要测试**某些指标和价格相关性**的主观交易者，拥有指标时序数据且**不必是日频数据**

## Table of Contents
- [Installation](#installation)
- [Usage](#usage)

## Installation
```bash
git clone https://github.com/tina-wen/quant_trade.git
```
## Usage
### 期货择时交易规则
- 当前仅支持**同一个账户**中对**同一合约持仓**只能为**纯多头或纯空头**：当遍历账户持仓时，同时出现多头和空头，报错  
- **先开先平**：同一方向持仓，优先平仓更早的  
- 默认按**前一天收盘价生成量价因子**，按**后一天开盘价进行交易**：如果输入价格序列中未明确指定收盘价或开盘价序列，注意*未来函数*  
- 默认按**回测周期的高、低价**判断持仓在当日**是否需要止损**：在输入价格序列中指定最高价和最低价序列  

### 输入
- 标的合约历史价格时间序列(**required**,supported format:.csv)：必须按照时间先后顺序，必须包含开、收、高、低价格列和每日结算价格列  
- 生成交易信号的其他外部因子时序(optional,supported format:.csv)：必须按照时间先后顺序
- 目前只支持**dataframe格式的价格数据**生成交易信号。可自行定义取数接口，修改get_data.py文件如下部分
```python
# 获取合约信息、价格数据等，无论是通过本地文件还是外部接口，逻辑都独立出来
contract_info_list = {'A1301.XDCE':{'margin_type':'float','margin_ratio':0.07,'margin':None,'commission_type':'fixed','commission_fee':2.0,'commission_rate':None,'times':10}}
# 待改，需要和args抽离开，只与code相关，出于性能考虑或改为数据库逻辑
from get_args import args
price_df = pd.read_csv(args.price_csv,index_col = args.time_col)
```
  
### 指定参数及含义
- init_fund 初始资金；code 合约代码；shares 合约手数；
- price_csv csv格式价格文件名及路径；time_col 时间列；source_col 用于生成信号的列；
- start_time 回测开始时间 yyyy-mm-dd；end_time 回测结束时间 yyyy-mm-dd；
- trade_strategy 策略名（ma 移动平均，dma 双均线，mom 动量，qtl 历史分位数，abs 绝对值，mr 均值回归）

| 策略       | 涉及参数                     | 参数名 (get_args.py)     |
|:-----------|:-----------------------------|:--------------------------|
| 移动平均   | 滞后期                       | `--lag`                   |
| 双均线     | 短均线、长均线               | `--short`, `--long`       |
| 动量       | 滞后期                       | `--lag`                   |
| 历史分位数 | 低分位数、高分位数           | `--lbr`, `--ubr`          |
| 绝对值     | 绝对水平                     | `--level`                 |
| 均值回归   | 滞后期、偏离均值的标准差倍数 | `--lag`, `--threshold`    |

:warning:本项目支持自定义信号回测，信号生成与回测功能解耦；以上策略仅为示例，具体代码可参考signals.py

## Quick Start

To run tests, simply use the following command to obtain performances of the given strategy on the given dataset

```bash
bash test.sh 
```
以上命令对曾在DCE上市的A1301合约日度价格执行双均线策略，回测结果如下
<pre>new account successfully created  
用户demo本次模拟的年化收益：69.93%，夏普：1.2，最大回撤：25.56%，胜率：47.83%，盈亏比：2.76 </pre>
生成日志部分结果如下
<pre>INFO:root:交易日2011-08-10的账户权益为1000000.0，流动资金为1000000.0，总保证金占用为0
INFO:root:交易日2011-08-11的账户权益为1000000.0，流动资金为1000000.0，总保证金占用为0
INFO:root:交易日2011-08-12 00:00:00，合约A1301.XDCE开仓1手，方向为short，开仓价为4736.0，手续费为20.0，保证金占用3315.2000000000003
INFO:root:账户权益为999980.0，当前账户流动资金为996664.8
INFO:root:交易日2011-08-12 00:00:00，合约A1301.XDCE开仓1手，方向为short，开仓价为4736.0，手续费为20.0，保证金占用3315.2000000000003
INFO:root:账户权益为999960.0，当前账户流动资金为993329.6000000001
INFO:root:交易日2011-08-12 00:00:00，合约A1301.XDCE开仓1手，方向为short，开仓价为4736.0，手续费为20.0，保证金占用3315.2000000000003
INFO:root:账户权益为999940.0，当前账户流动资金为989994.4000000001
INFO:root:交易日2011-08-12 00:00:00，合约A1301.XDCE开仓1手，方向为short，开仓价为4736.0，手续费为20.0，保证金占用3315.2000000000003
INFO:root:账户权益为999920.0，当前账户流动资金为986659.2000000002
INFO:root:交易日2011-08-12 00:00:00，合约A1301.XDCE开仓1手，方向为short，开仓价为4736.0，手续费为20.0，保证金占用3315.2000000000003
INFO:root:账户权益为999900.0，当前账户流动资金为983324.0000000002</pre>

## TODO List
- [ ] 多合约回测
- [ ] 自动化取数功能（日度结算价，各合约的基本信息如保证金收取方式、保证金比例或绝对值、手续费收取方式，手续费比例或绝对值，报价倍数）；
- [ ] 可视化策略绩效图表
- [ ] 因子库模式，对于标的合约历史价格序列，自动挖掘有效因子

## 未完工！
👁️‍🗨️业余选手造的无聊小轮子：
欢迎提ISSUE/PR/贡献，求star
